<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>抑郁症分析系统 - 分析中心</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <script src="localdb.js"></script>
    <!-- 核心同步系统 - 全新统一的同步架构 -->
    <script src="core_sync_init.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#6366f1',
                        accent: '#8b5cf6',
                        dark: '#1e293b',
                        light: '#f8fafc',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444',
                        info: '#06b6d4',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                },
            }
        }
    </script>
    <style>
        .content-auto { content-visibility: auto; }
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); }
        .hover-scale { transition: transform 0.2s; }
        .hover-scale:hover { transform: scale(1.05); }
        .file-drop-area { border: 2px dashed #d1d5db; border-radius: 0.5rem; padding: 2rem; text-align: center; cursor: pointer; transition: all 0.2s; }
        .file-drop-area:hover { border-color: #3b82f6; background-color: rgba(59,130,246,0.05); }
        .model-card-active { border-color: #3b82f6; background-color: rgba(59,130,246,0.05); }
    </style>
</head>
<body class="bg-gray-50 font-sans min-h-screen">
    <nav class="bg-white shadow-md fixed top-0 left-0 right-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fa fa-heartbeat text-primary text-2xl"></i>
                <span class="text-xl font-bold text-dark">抑郁症分析系统</span>
            </div>
            <div class="hidden md:flex items-center space-x-6">
                <a href="index.html" class="text-gray-600 hover:text-primary transition-colors">首页</a>
                <a href="analysis.html" class="text-primary font-medium">分析中心</a>
                <a href="user_center.html" class="text-gray-600 hover:text-primary transition-colors">用户中心</a>
                <div class="flex items-center space-x-2">
                        <img src="m.jpg" alt="用户头像" id="nav-avatar-desktop" class="w-10 h-10 rounded-full object-cover border-2 border-primary">
                        <span id="nav-username-desktop" class="text-gray-700 font-medium">周光泽</span>
                    </div>
                <a href="login.html" class="text-gray-600 hover:text-danger transition-colors" id="desktop-logout-button">
                    <i class="fa fa-sign-out"></i> 退出
                </a>
            </div>
            <div class="md:hidden">
                <button id="menu-toggle" class="text-gray-600 hover:text-primary focus:outline-none">
                    <i class="fa fa-bars text-xl"></i>
                </button>
            </div>
        </div>
        <div id="mobile-menu" class="hidden md:hidden bg-white px-4 py-2 shadow-lg">
            <a href="index.html" class="block py-2 text-gray-600 hover:text-primary">首页</a>
            <a href="analysis.html" class="block py-2 text-primary font-medium">分析中心</a>
            <a href="user_center.html" class="block py-2 text-gray-600 hover:text-primary">用户中心</a>
            <div class="py-2 flex items-center space-x-2 border-t border-gray-100">
                    <img src="m.jpg" alt="用户头像" id="nav-avatar-mobile" class="w-8 h-8 rounded-full object-cover border-2 border-primary">
                        <span id="nav-username-mobile" class="text-gray-700 font-medium">周光泽</span>
                </div>
            <a href="login.html" class="block py-2 text-danger font-medium border-t border-gray-100" id="mobile-logout-button">
                <i class="fa fa-sign-out mr-2"></i> 退出
            </a>
        </div>
    </nav>

    <main class="container mx-auto px-4 pt-24 pb-16">
    
    <script>
        // 实现退出功能
        document.addEventListener('DOMContentLoaded', function() {
            // 桌面端退出按钮
            const desktopLogoutButton = document.getElementById('desktop-logout-button');
            if (desktopLogoutButton) {
                desktopLogoutButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    // 使用API服务注销
                    if (typeof ApiService !== 'undefined') {
                        const apiService = new ApiService();
                        apiService.logout();
                    }
                    // 清除所有登录相关的localStorage数据
                    localStorage.removeItem('userCredentials');
                    localStorage.removeItem('userLoggedIn');
                    localStorage.removeItem('currentUser');
                    localStorage.removeItem('savedCredentials');
                    localStorage.removeItem('authToken');
                    
                    // 显示退出成功提示
                    alert('退出成功');
                    
                    // 跳转到登录页
                    window.location.href = 'login.html';
                });
            }
            
            // 移动端退出按钮
            const mobileLogoutButton = document.getElementById('mobile-logout-button');
            if (mobileLogoutButton) {
                mobileLogoutButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    // 使用API服务注销
                    if (typeof ApiService !== 'undefined') {
                        const apiService = new ApiService();
                        apiService.logout();
                    }
                    // 清除所有登录相关的localStorage数据
                    localStorage.removeItem('userCredentials');
                    localStorage.removeItem('userLoggedIn');
                    localStorage.removeItem('currentUser');
                    localStorage.removeItem('savedCredentials');
                    localStorage.removeItem('authToken');
                    
                    // 显示退出成功提示
                    alert('退出成功');
                    
                    // 跳转到登录页
                    window.location.href = 'login.html';
                });
            }
        });
    </script>
        <div class="mb-8">
            <h1 class="text-2xl md:text-3xl font-bold text-dark mb-2">分析中心</h1>
            <p class="text-gray-500">上传心电脑电数据，获取专业的心理健康评估</p>
        </div>
        
        <div class="flex justify-between items-center mb-8">
            <div class="flex flex-col items-center">
                <div class="w-12 h-12 bg-primary text-white rounded-full flex items-center justify-center text-xl font-bold mb-2">1</div>
                <span class="text-sm text-primary font-medium">上传数据</span>
            </div>
            <div class="flex-1 h-1 bg-primary mx-4"></div>
            <div class="flex flex-col items-center">
                <div class="w-12 h-12 bg-gray-200 text-gray-500 rounded-full flex items-center justify-center text-xl font-bold mb-2">2</div>
                <span class="text-sm text-gray-500">选择模型</span>
            </div>
            <div class="flex-1 h-1 bg-gray-200 mx-4"></div>
            <div class="flex flex-col items-center">
                <div class="w-12 h-12 bg-gray-200 text-gray-500 rounded-full flex items-center justify-center text-xl font-bold mb-2">3</div>
                <span class="text-sm text-gray-500">分析结果</span>
            </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 space-y-8">
                <div class="bg-white rounded-xl card-shadow p-6">
                    <h3 class="text-lg font-semibold text-dark mb-6">数据上传</h3>
                    
                    <div id="file-drop-area" class="file-drop-area mb-6">
                        <i class="fa fa-cloud-upload text-4xl text-gray-400 mb-4"></i>
                        <h4 class="text-lg font-medium text-gray-700 mb-2">拖拽文件到此处上传</h4>
                        <p class="text-sm text-gray-500 mb-4">支持格式：CSV, JSON, TXT</p>
                        <label for="file-input" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-md cursor-pointer transition-colors inline-flex items-center">
                            <i class="fa fa-folder-open-o mr-2"></i> 选择文件
                        </label>
                        <input id="file-input" type="file" accept=".csv,.json,.txt" class="hidden">
                    </div>
                    
                    <div id="selected-file" class="hidden mb-6">
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200">
                            <div class="flex items-center">
                                <i class="fa fa-file-text-o text-primary text-xl mr-3"></i>
                                <span id="file-name" class="text-gray-700 truncate max-w-xs">sample_data.csv</span>
                            </div>
                            <button id="remove-file" class="text-gray-400 hover:text-danger transition-colors">
                                <i class="fa fa-times text-lg"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">数据类型</label>
                        <div class="grid grid-cols-2 gap-4">
                            <label class="flex items-center p-3 border border-gray-300 rounded-lg cursor-pointer hover:border-primary transition-colors">
                                <input type="radio" name="data-type" value="ecg" class="h-4 w-4 text-primary focus:ring-primary border-gray-300">
                                <span class="ml-2 text-gray-700">心电图数据</span>
                            </label>
                            <label class="flex items-center p-3 border border-gray-300 rounded-lg cursor-pointer hover:border-primary transition-colors">
                                <input type="radio" name="data-type" value="eeg" class="h-4 w-4 text-primary focus:ring-primary border-gray-300">
                                <span class="ml-2 text-gray-700">脑电图数据</span>
                            </label>
                        </div>
                    </div>
                    
                    <button id="next-step-btn" class="w-full bg-primary hover:bg-primary/90 text-white font-medium py-3 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <span>下一步：选择模型</span>
                        <i class="fa fa-arrow-right"></i>
                    </button>
                </div>
                
                <div id="model-selection-card" class="bg-white rounded-xl card-shadow p-6 hidden">
                    <h3 class="text-lg font-semibold text-dark mb-6">选择分析模型</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div id="svm-model" class="border-2 border-gray-300 hover:border-primary rounded-lg p-6 cursor-pointer transition-all duration-200">
                            <div class="flex justify-between items-start mb-4">
                                <div class="w-12 h-12 bg-primary/10 rounded-full flex items-center justify-center">
                                    <i class="fa fa-line-chart text-primary text-xl"></i>
                                </div>
                                <input type="radio" name="model" value="svm" class="h-5 w-5 text-primary focus:ring-primary border-gray-300">
                            </div>
                            <h4 class="text-xl font-semibold text-dark mb-2">SVM模型</h4>
                            <p class="text-gray-600 mb-4">支持向量机模型，适合高维数据分类，在特征明显时准确性高。</p>
                            <div class="flex justify-between items-center text-sm">
                                <span class="text-gray-500">准确率: <span class="font-medium text-primary">92%</span></span>
                                <span class="text-gray-500">处理速度: <span class="font-medium text-primary">较快</span></span>
                            </div>
                        </div>
                        
                        <div id="random-forest-model" class="border-2 border-gray-300 hover:border-primary rounded-lg p-6 cursor-pointer transition-all duration-200">
                            <div class="flex justify-between items-start mb-4">
                                <div class="w-12 h-12 bg-secondary/10 rounded-full flex items-center justify-center">
                                    <i class="fa fa-tree text-secondary text-xl"></i>
                                </div>
                                <input type="radio" name="model" value="random-forest" class="h-5 w-5 text-primary focus:ring-primary border-gray-300">
                            </div>
                            <h4 class="text-xl font-semibold text-dark mb-2">随机森林</h4>
                            <p class="text-gray-600 mb-4">集成学习算法，对噪声数据有较好的鲁棒性，适合复杂特征分析。</p>
                            <div class="flex justify-between items-center text-sm">
                                <span class="text-gray-500">准确率: <span class="font-medium text-secondary">94%</span></span>
                                <span class="text-gray-500">处理速度: <span class="font-medium text-secondary">中等</span></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row gap-4">
                        <button id="back-to-upload" class="flex-1 bg-white hover:bg-gray-50 text-primary border border-primary px-4 py-3 rounded-lg transition-colors duration-200 flex items-center justify-center">
                            <i class="fa fa-arrow-left mr-2"></i>
                            <span>返回上传</span>
                        </button>
                        <button id="start-analysis-btn" class="flex-1 bg-primary hover:bg-primary/90 text-white font-medium py-3 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <span>开始分析</span>
                            <i class="fa fa-play"></i>
                        </button>
                    </div>
                </div>
                
                <div id="analysis-result-card" class="bg-white rounded-xl card-shadow p-6 hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-semibold text-dark">分析结果</h3>
                        <div class="flex space-x-2">
                            <button class="text-gray-500 hover:text-gray-700 transition-colors">
                                <i class="fa fa-download mr-1"></i> 下载报告
                            </button>
                            <button class="text-gray-500 hover:text-gray-700 transition-colors">
                                <i class="fa fa-share-alt mr-1"></i> 分享
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-gray-50 rounded-xl p-6 text-center">
                            <h4 class="text-gray-600 mb-2">心理健康指数</h4>
                            <div class="text-4xl font-bold text-primary mb-2">85</div>
                            <div class="text-sm text-success font-medium">良好状态</div>
                        </div>
                        
                        <div class="bg-gray-50 rounded-xl p-6 text-center">
                            <h4 class="text-gray-600 mb-2">使用模型</h4>
                            <div class="text-2xl font-bold text-dark mb-2">SVM模型</div>
                            <div class="text-sm text-gray-500">置信度: 92%</div>
                        </div>
                        
                        <div class="bg-gray-50 rounded-xl p-6 text-center">
                            <h4 class="text-gray-600 mb-2">分析时间</h4>
                            <div class="text-xl font-bold text-dark mb-2">2023-07-28</div>
                            <div class="text-sm text-gray-500">15:30:45</div>
                        </div>
                    </div>
                    
                    <div class="mb-8">
                        <h4 class="text-lg font-semibold text-dark mb-4">详细分析</h4>
                        <div class="space-y-4">
                            <div>
                                <div class="flex justify-between mb-2">
                                    <span class="text-gray-600">情绪稳定性</span>
                                    <span class="font-medium text-primary">88%</span>
                                </div>
                                <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                                    <div class="h-full bg-primary rounded-full" style="width: 88%"></div>
                                </div>
                            </div>
                            
                            <div>
                                <div class="flex justify-between mb-2">
                                    <span class="text-gray-600">压力水平</span>
                                    <span class="font-medium text-success">45%</span>
                                </div>
                                <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                                    <div class="h-full bg-success rounded-full" style="width: 45%"></div>
                                </div>
                            </div>
                            
                            <div>
                                <div class="flex justify-between mb-2">
                                    <span class="text-gray-600">认知功能</span>
                                    <span class="font-medium text-info">92%</span>
                                </div>
                                <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                                    <div class="h-full bg-info rounded-full" style="width: 92%"></div>
                                </div>
                            </div>
                            
                            <div>
                                <div class="flex justify-between mb-2">
                                    <span class="text-gray-600">睡眠质量</span>
                                    <span class="font-medium text-warning">72%</span>
                                </div>
                                <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                                    <div class="h-full bg-warning rounded-full" style="width: 72%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-8">
                        <h4 class="text-lg font-semibold text-dark mb-4">健康建议</h4>
                        <div class="bg-blue-50 border-l-4 border-primary p-4 rounded">
                            <p class="text-gray-700 mb-3">
                                根据您的分析结果，您的心理健康状态良好。以下是一些建议帮助您维持良好状态：
                            </p>
                            <ul class="text-gray-700 space-y-2">
                                <li class="flex items-start">
                                    <i class="fa fa-check-circle text-primary mt-1 mr-2"></i>
                                    <span>保持规律的作息时间，每天保证7-8小时睡眠</span>
                                </li>
                                <li class="flex items-start">
                                    <i class="fa fa-check-circle text-primary mt-1 mr-2"></i>
                                    <span>每周进行至少150分钟中等强度的体育锻炼</span>
                                </li>
                                <li class="flex items-start">
                                    <i class="fa fa-check-circle text-primary mt-1 mr-2"></i>
                                    <span>保持健康均衡的饮食，减少咖啡因和酒精摄入</span>
                                </li>
                                <li class="flex items-start">
                                    <i class="fa fa-check-circle text-primary mt-1 mr-2"></i>
                                    <span>建议每两周进行一次心理健康监测，记录情绪变化</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row gap-4">
                        <button id="new-analysis-btn" class="flex-1 bg-primary hover:bg-primary/90 text-white font-medium py-3 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center">
                            <i class="fa fa-plus mr-2"></i>
                            <span>新建分析</span>
                        </button>
                        <button id="save-result-btn" class="flex-1 bg-success hover:bg-success/90 text-white font-medium py-3 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center">
                            <i class="fa fa-save mr-2"></i>
                            <span>保存结果</span>
                        </button>
                        <button id="view-history-btn" class="flex-1 bg-white hover:bg-gray-50 text-primary border border-primary px-4 py-3 rounded-lg transition-colors duration-200 flex items-center justify-center">
                            <i class="fa fa-history mr-2"></i>
                            <span>查看历史</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="lg:col-span-1">
                <div class="bg-white rounded-xl card-shadow p-6 sticky top-24">
                    <h3 class="text-lg font-semibold text-dark mb-6">生理指标雷达图</h3>
                    
                    <div class="h-72 mb-6">
                        <canvas id="physiologicalChart"></canvas>
                    </div>
                    
                    <div class="space-y-4">
                        <h4 class="font-medium text-gray-700 mb-2">参考标准</h4>
                        <div class="flex items-center text-sm mb-1">
                            <span class="w-3 h-3 bg-danger rounded-full mr-2"></span>
                            <span class="text-gray-600">需关注 (&lt; 60)</span>
                        </div>
                        <div class="flex items-center text-sm mb-1">
                            <span class="w-3 h-3 bg-warning rounded-full mr-2"></span>
                            <span class="text-gray-600">一般 (60-79)</span>
                        </div>
                        <div class="flex items-center text-sm">
                            <span class="w-3 h-3 bg-success rounded-full mr-2"></span>
                            <span class="text-gray-600">良好 (≥ 80)</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-dark text-gray-300 py-8">
        <div class="container mx-auto px-4 text-center">
            <p class="mb-4"><i class="fa fa-heartbeat text-primary mr-2"></i>抑郁症分析系统 - 关注心理健康，科学预防抑郁症</p>
            <div class="flex justify-center space-x-6 mb-4">
                <a href="#" class="text-gray-400 hover:text-white transition-colors">
                    <i class="fa fa-weixin text-xl"></i>
                </a>
                <a href="#" class="text-gray-400 hover:text-white transition-colors">
                    <i class="fa fa-weibo text-xl"></i>
                </a>
                <a href="#" class="text-gray-400 hover:text-white transition-colors">
                    <i class="fa fa-qq text-xl"></i>
                </a>
            </div>
            <p class="text-sm text-gray-500">&copy; 2023 抑郁症分析系统. 保留所有权利.</p>
        </div>
    </footer>

    <script>
        // 移动端菜单切换
        const menuToggle = document.getElementById('menu-toggle');
        const mobileMenu = document.getElementById('mobile-menu');
        
        menuToggle.addEventListener('click', () => {
            mobileMenu.classList.toggle('hidden');
        });
        
        // 文件上传功能
        const fileDropArea = document.getElementById('file-drop-area');
        const fileInput = document.getElementById('file-input');
        const selectedFile = document.getElementById('selected-file');
        const fileName = document.getElementById('file-name');
        const removeFile = document.getElementById('remove-file');
        const nextStepBtn = document.getElementById('next-step-btn');
        const dataTypeRadios = document.querySelectorAll('input[name="data-type"]');
        
        // 文件拖放功能
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            fileDropArea.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            fileDropArea.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            fileDropArea.addEventListener(eventName, unhighlight, false);
        });
        
        function highlight() {
            fileDropArea.classList.add('border-primary', 'bg-primary/5');
        }
        
        function unhighlight() {
            fileDropArea.classList.remove('border-primary', 'bg-primary/5');
        }
        
        // 处理文件拖放
        fileDropArea.addEventListener('drop', handleDrop, false);
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length) {
                handleFiles(files[0]);
            }
        }
        
        // 处理文件选择
        fileInput.addEventListener('change', function() {
            if (this.files.length) {
                handleFiles(this.files[0]);
            }
        });
        
        function handleFiles(file) {
            // 存储上传的文件到全局变量
            uploadedFile = file;
            // 显示选中的文件
            fileName.textContent = file.name;
            selectedFile.classList.remove('hidden');
            
            // 检查文件类型
            const validExtensions = ['.csv', '.json', '.txt'];
            const isValidType = validExtensions.some(ext => 
                file.name.toLowerCase().endsWith(ext)
            );
            
            if (!isValidType) {
                alert('请上传CSV、JSON或TXT格式的文件');
                removeFile.click();
                return;
            }
            
            // 检查是否选择了数据类型
            checkEnableNextButton();
        }
        
        // 移除文件
        removeFile.addEventListener('click', function() {
            selectedFile.classList.add('hidden');
            fileInput.value = '';
            checkEnableNextButton();
        });
        
        // 监听数据类型选择变化
        dataTypeRadios.forEach(radio => {
            radio.addEventListener('change', checkEnableNextButton);
        });
        
        // 检查是否可以启用下一步按钮
        function checkEnableNextButton() {
            const hasFile = !selectedFile.classList.contains('hidden');
            const hasDataType = Array.from(dataTypeRadios).some(radio => radio.checked);
            
            nextStepBtn.disabled = !(hasFile && hasDataType);
        }
        
        // 模型选择功能
        const modelSelectionCard = document.getElementById('model-selection-card');
        const svmModel = document.getElementById('svm-model');
        const randomForestModel = document.getElementById('random-forest-model');
        const modelRadios = document.querySelectorAll('input[name="model"]');
        const startAnalysisBtn = document.getElementById('start-analysis-btn');
        const backToUpload = document.getElementById('back-to-upload');
        const analysisResultCard = document.getElementById('analysis-result-card');
        const stepIndicators = document.querySelectorAll('.flex-col.items-center');
        
        // 下一步按钮点击事件
        nextStepBtn.addEventListener('click', function() {
            // 显示模型选择卡片
            modelSelectionCard.classList.remove('hidden');
            
            // 更新步骤指示器
            stepIndicators[1].querySelector('div').classList.remove('bg-gray-200', 'text-gray-500');
            stepIndicators[1].querySelector('div').classList.add('bg-primary', 'text-white');
            stepIndicators[1].querySelector('span').classList.remove('text-gray-500');
            stepIndicators[1].querySelector('span').classList.add('text-primary', 'font-medium');
            stepIndicators[0].querySelector('div').classList.remove('bg-primary', 'text-white');
            stepIndicators[0].querySelector('div').classList.add('bg-gray-200', 'text-gray-500');
            stepIndicators[0].querySelector('span').classList.remove('text-primary', 'font-medium');
            stepIndicators[0].querySelector('span').classList.add('text-gray-500');
            stepIndicators[0].nextElementSibling.classList.remove('bg-primary');
            stepIndicators[0].nextElementSibling.classList.add('bg-gray-200');
        });
        
        // 返回上传按钮点击事件
        backToUpload.addEventListener('click', function() {
            // 隐藏模型选择卡片
            modelSelectionCard.classList.add('hidden');
            
            // 重置模型选择
            modelRadios.forEach(radio => radio.checked = false);
            svmModel.classList.remove('model-card-active');
            randomForestModel.classList.remove('model-card-active');
            startAnalysisBtn.disabled = true;
            
            // 更新步骤指示器
            stepIndicators[1].querySelector('div').classList.remove('bg-primary', 'text-white');
            stepIndicators[1].querySelector('div').classList.add('bg-gray-200', 'text-gray-500');
            stepIndicators[1].querySelector('span').classList.remove('text-primary', 'font-medium');
            stepIndicators[1].querySelector('span').classList.add('text-gray-500');
            stepIndicators[0].querySelector('div').classList.remove('bg-gray-200', 'text-gray-500');
            stepIndicators[0].querySelector('div').classList.add('bg-primary', 'text-white');
            stepIndicators[0].querySelector('span').classList.remove('text-gray-500');
            stepIndicators[0].querySelector('span').classList.add('text-primary', 'font-medium');
            stepIndicators[0].nextElementSibling.classList.remove('bg-gray-200');
            stepIndicators[0].nextElementSibling.classList.add('bg-primary');
        });
        
        // 点击模型卡片选择模型
        svmModel.addEventListener('click', function() {
            document.querySelector('input[name="model"][value="svm"]').checked = true;
            svmModel.classList.add('model-card-active');
            randomForestModel.classList.remove('model-card-active');
            startAnalysisBtn.disabled = false;
        });
        
        randomForestModel.addEventListener('click', function() {
            document.querySelector('input[name="model"][value="random-forest"]').checked = true;
            randomForestModel.classList.add('model-card-active');
            svmModel.classList.remove('model-card-active');
            startAnalysisBtn.disabled = false;
        });
        
        // 全局变量存储上传的文件
        let uploadedFile = null;
        
        // 开始分析按钮点击事件
        startAnalysisBtn.addEventListener('click', function() {
            // 确保有上传的文件
            if (!uploadedFile) {
                alert('请先上传数据文件');
                return;
            }
            
            // 确保有选择的模型
            const selectedModelRadio = document.querySelector('input[name="model"]:checked');
            if (!selectedModelRadio) {
                alert('请选择一个分析模型');
                return;
            }
            
            // 显示加载状态
            this.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>分析中...';
            this.disabled = true;
            
            // 获取选择的模型
            const selectedModel = selectedModelRadio.value;
            
            // 模拟分析过程
            setTimeout(function() {
                // 隐藏模型选择卡片
                modelSelectionCard.classList.add('hidden');
                
                // 显示分析结果卡片
                analysisResultCard.classList.remove('hidden');
                
                // 更新步骤指示器
                stepIndicators[2].querySelector('div').classList.remove('bg-gray-200', 'text-gray-500');
                stepIndicators[2].querySelector('div').classList.add('bg-primary', 'text-white');
                stepIndicators[2].querySelector('span').classList.remove('text-gray-500');
                stepIndicators[2].querySelector('span').classList.add('text-primary', 'font-medium');
                stepIndicators[1].querySelector('div').classList.remove('bg-primary', 'text-white');
                stepIndicators[1].querySelector('div').classList.add('bg-gray-200', 'text-gray-500');
                stepIndicators[1].querySelector('span').classList.remove('text-primary', 'font-medium');
                stepIndicators[1].querySelector('span').classList.add('text-gray-500');
                stepIndicators[1].nextElementSibling.classList.remove('bg-gray-200');
                stepIndicators[1].nextElementSibling.classList.add('bg-primary');
                
                // 根据选择的模型更新结果数据
                    updateAnalysisResults(selectedModel).catch(error => {
                        // 静默处理错误
                        // 即使发生错误，也确保初始化雷达图
                        try {
                            initPhysiologicalChart();
                        } catch (chartError) {
                            // 静默处理雷达图初始化错误
                        }
                    });
                
            }, 2000);
        });
        
        // 根据选择的模型更新分析结果
        async function updateAnalysisResults(model) {
            // 获取当前日期时间
            const now = new Date();
            const date = now.toLocaleDateString('zh-CN');
            const time = now.toLocaleTimeString('zh-CN');
            
            // 根据选择的模型设置不同的结果数据
            let modelName, confidence, healthIndex, details, advice;
            
            if (model === 'svm') {
                modelName = 'SVM模型';
                confidence = '92%';
                healthIndex = 85;
                details = {
                    '情绪稳定性': 88,
                    '压力水平': 45,
                    '认知功能': 92,
                    '睡眠质量': 72
                };
                advice = '根据您的分析结果，您的心理健康状态良好。以下是一些建议帮助您维持良好状态：';
            } else {
                modelName = '随机森林';
                confidence = '94%';
                healthIndex = 87;
                details = {
                    '情绪稳定性': 90,
                    '压力水平': 42,
                    '认知功能': 95,
                    '睡眠质量': 70
                };
                advice = '随机森林模型分析结果显示您的心理健康状态良好。以下是专业建议帮助您维持和改善：';
            }
            
            // 更新结果显示
            document.querySelector('.text-4xl.font-bold.text-primary').textContent = healthIndex;
            document.querySelector('.text-2xl.font-bold.text-dark').textContent = modelName;
            document.querySelector('.text-sm.text-gray-500').textContent = `置信度: ${confidence}`;
            document.querySelector('.text-xl.font-bold.text-dark.mb-2').textContent = date;
            document.querySelector('.text-sm.text-gray-500').nextElementSibling.textContent = time;
            
            // 更新详细分析数据
            const detailItems = document.querySelectorAll('.space-y-4 > div');
            let index = 0;
            for (const [key, value] of Object.entries(details)) {
                if (index < detailItems.length) {
                    detailItems[index].querySelector('span.text-gray-600').textContent = key;
                    detailItems[index].querySelector('span.font-medium').textContent = `${value}%`;
                    detailItems[index].querySelector('.h-full').style.width = `${value}%`;
                    index++;
                }
            }
            
            // 更新健康建议
            document.querySelector('.bg-blue-50.border-l-4.border-primary.p-4.rounded p:first-child').textContent = advice;
            
            // 准备保存的记录数据，确保格式统一
            const resultData = {
                date: date,
                model: modelName,
                healthIndex: healthIndex,
                confidence: confidence,
                details: details,
                advice: advice,
                timestamp: now.getTime(),
                createdAt: new Date().toISOString()
            };
            
            // 保存分析结果到历史记录 - 修复后的保存逻辑
            async function saveAnalysisResult() {
                try {
                    let saved = false;
                    console.log('[AnalysisCenter] 开始保存分析结果...');
                    
                    // 优先使用核心同步系统
                    if (window.coreSyncSystem && typeof window.coreSyncSystem.addAnalysisRecord === 'function') {
                        console.log('[AnalysisCenter] 使用核心同步系统保存记录');
                        try {
                            await window.coreSyncSystem.addAnalysisRecord(resultData);
                            saved = true;
                        } catch (coreError) {
                            console.error('[AnalysisCenter] 核心同步系统保存失败:', coreError);
                        }
                    }
                    
                    // 降级方案1：使用同步桥接器
                    if (!saved && window.syncBridge && typeof window.syncBridge.onAnalysisRecordAdded === 'function') {
                        console.log('[AnalysisCenter] 使用同步桥接器保存记录');
                        try {
                            await window.syncBridge.onAnalysisRecordAdded(resultData);
                            saved = true;
                        } catch (bridgeError) {
                            console.error('[AnalysisCenter] 同步桥接器保存失败:', bridgeError);
                        }
                    }
                    
                    // 降级方案2：使用localDB
                    if (!saved && window.localDB && typeof window.localDB.addAnalysisRecord === 'function') {
                        console.log('[AnalysisCenter] 使用localDB保存记录');
                        try {
                            await window.localDB.addAnalysisRecord(resultData);
                            saved = true;
                        } catch (dbError) {
                            console.error('[AnalysisCenter] localDB保存失败:', dbError);
                        }
                    }
                    
                    // 最终降级方案：直接使用localStorage
                    if (!saved) {
                        console.log('[AnalysisCenter] 使用localStorage保存记录');
                        try {
                            let historyRecords = JSON.parse(localStorage.getItem('analysisHistory') || '[]');
                            historyRecords.unshift(resultData);
                            
                            if (historyRecords.length > 100) {
                                historyRecords = historyRecords.slice(0, 100);
                            }
                            
                            localStorage.setItem('analysisHistory', JSON.stringify(historyRecords));
                            saved = true;
                            console.log('[AnalysisCenter] 成功保存到localStorage，历史记录总数:', historyRecords.length);
                        } catch (storageError) {
                            console.error('[AnalysisCenter] localStorage保存失败:', storageError);
                        }
                    }
                    
                    // 触发分析历史更新事件
                    if (saved) {
                        console.log('[AnalysisCenter] 分析结果保存成功');
                        try {
                            const event = new CustomEvent('analysisHistoryUpdated', {
                                detail: { 
                                    message: '分析历史已更新', 
                                    timestamp: Date.now(),
                                    newRecord: resultData
                                }
                            });
                            window.dispatchEvent(event);
                            console.log('[AnalysisCenter] 已触发分析历史更新事件');
                        } catch (eventError) {
                            console.error('[AnalysisCenter] 触发事件失败:', eventError);
                        }
                    }
                    
                    return saved;
                } catch (error) {
                    console.error('[AnalysisCenter] 保存分析结果时发生异常:', error);
                    return false;
                }
            }
            
            // 执行保存
            await saveAnalysisResult();
            
            // 初始化生理指标雷达图
            try {
                initPhysiologicalChart();
            } catch (chartError) {
                // 静默处理雷达图初始化错误
            }
        }
        
        // 新建分析按钮点击事件
        document.getElementById('new-analysis-btn').addEventListener('click', function() {
            // 重置所有状态
            analysisResultCard.classList.add('hidden');
            modelSelectionCard.classList.add('hidden');
            selectedFile.classList.add('hidden');
            fileInput.value = '';
            dataTypeRadios.forEach(radio => radio.checked = false);
            modelRadios.forEach(radio => radio.checked = false);
            nextStepBtn.disabled = true;
            startAnalysisBtn.disabled = true;
            svmModel.classList.remove('model-card-active');
            randomForestModel.classList.remove('model-card-active');
            
            // 重置步骤指示器
            stepIndicators[0].querySelector('div').classList.remove('bg-gray-200', 'text-gray-500');
            stepIndicators[0].querySelector('div').classList.add('bg-primary', 'text-white');
            stepIndicators[0].querySelector('span').classList.remove('text-gray-500');
            stepIndicators[0].querySelector('span').classList.add('text-primary', 'font-medium');
            stepIndicators[0].nextElementSibling.classList.remove('bg-gray-200');
        });
        
        // 保存结果按钮点击事件
        document.getElementById('save-result-btn').addEventListener('click', async function() {
            const btn = this;
            const originalText = btn.innerHTML;
            
            // 禁用按钮防止重复点击
            btn.disabled = true;
            btn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>保存中...';
            
            try {
                console.log('[AnalysisCenter] 开始保存分析结果（手动保存）');
                
                // 获取当前显示的分析结果数据
                const date = document.querySelector('#analysis-result-card .text-xl.font-bold.text-dark.mb-2').textContent;
                const modelName = document.querySelector('#analysis-result-card .text-2xl.font-bold.text-dark.mb-2').textContent;
                const healthIndex = parseInt(document.querySelector('#analysis-result-card .text-4xl.font-bold.text-primary.mb-2').textContent);
                const confidenceText = document.querySelector('#analysis-result-card .text-sm.text-gray-500').textContent;
                const confidence = parseInt(confidenceText.match(/\d+/)[0]);
                
                // 获取详细指标
                const detailItems = document.querySelectorAll('#analysis-result-card .flex.justify-between.mb-2');
                const details = {};
                
                detailItems.forEach(item => {
                    const label = item.querySelector('span:first-child').textContent;
                    const value = parseInt(item.querySelector('span:last-child').textContent.match(/\d+/)[0]);
                    
                    // 统一格式，保持与updateAnalysisResults中的格式一致
                    details[label] = value;
                });
                
                // 获取健康建议
                const advice = document.querySelector('.bg-blue-50.border-l-4.border-primary.p-4.rounded p:first-child').textContent;
                
                // 创建分析结果对象 - 确保格式统一
                const resultData = {
                    date: date,
                    model: modelName,
                    healthIndex: healthIndex,
                    confidence: confidence + '%',
                    details: details,
                    advice: advice,
                    timestamp: Date.now(),
                    createdAt: new Date().toISOString()
                };
                
                console.log('[AnalysisCenter] 准备保存的数据:', resultData);
                
                // 尝试保存分析结果
                let saved = false;
                
                // 优先使用核心同步系统
                if (window.coreSyncSystem && typeof window.coreSyncSystem.addAnalysisRecord === 'function') {
                    console.log('[AnalysisCenter] 使用核心同步系统保存记录');
                    try {
                        await window.coreSyncSystem.addAnalysisRecord(resultData);
                        saved = true;
                    } catch (coreError) {
                        console.error('[AnalysisCenter] 核心同步系统保存失败:', coreError);
                    }
                }
                
                // 降级方案1：使用同步桥接器
                if (!saved && window.syncBridge && typeof window.syncBridge.onAnalysisRecordAdded === 'function') {
                    console.log('[AnalysisCenter] 使用同步桥接器保存记录');
                    try {
                        await window.syncBridge.onAnalysisRecordAdded(resultData);
                        saved = true;
                    } catch (bridgeError) {
                        console.error('[AnalysisCenter] 同步桥接器保存失败:', bridgeError);
                    }
                }
                
                // 降级方案2：使用localDB
                if (!saved && window.localDB && typeof window.localDB.addAnalysisRecord === 'function') {
                    console.log('[AnalysisCenter] 使用localDB保存记录');
                    try {
                        await window.localDB.addAnalysisRecord(resultData);
                        saved = true;
                    } catch (dbError) {
                        console.error('[AnalysisCenter] localDB保存失败:', dbError);
                    }
                }
                
                // 最终降级方案：直接使用localStorage
                if (!saved) {
                    console.log('[AnalysisCenter] 使用localStorage保存记录');
                    try {
                        let historyRecords = JSON.parse(localStorage.getItem('analysisHistory') || '[]');
                        historyRecords.unshift(resultData);
                        
                        if (historyRecords.length > 100) {
                            historyRecords = historyRecords.slice(0, 100);
                        }
                        
                        localStorage.setItem('analysisHistory', JSON.stringify(historyRecords));
                        saved = true;
                        console.log('[AnalysisCenter] 成功保存到localStorage，历史记录总数:', historyRecords.length);
                    } catch (storageError) {
                        console.error('[AnalysisCenter] localStorage保存失败:', storageError);
                    }
                }
                
                if (saved) {
                    // 显示保存成功提示
                    alert('分析结果已成功保存！');
                    console.log('[AnalysisCenter] 手动保存成功');
                    
                    // 触发分析历史更新事件
                    try {
                        const event = new CustomEvent('analysisHistoryUpdated', {
                            detail: {
                                message: '分析历史已更新',
                                timestamp: Date.now(),
                                newRecord: resultData,
                                source: 'manual_save'
                            }
                        });
                        window.dispatchEvent(event);
                        console.log('[AnalysisCenter] 已触发分析历史更新事件');
                    } catch (eventError) {
                        console.error('[AnalysisCenter] 触发事件失败:', eventError);
                    }
                } else {
                    // 所有保存方法都失败
                    console.error('[AnalysisCenter] 所有保存方法都失败');
                    alert('保存失败，请稍后重试');
                }
            } catch (error) {
                console.error('[AnalysisCenter] 手动保存过程中发生异常:', error);
                alert('保存失败，请稍后重试');
            } finally {
                // 恢复按钮状态
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        });
        document.getElementById('view-history-btn').addEventListener('click', function() {
            // 直接跳转到用户中心页面
            window.location.href = 'user_center.html';
        });
        

        
        // 初始化生理指标雷达图
        function initPhysiologicalChart() {
            const ctx = document.getElementById('physiologicalChart').getContext('2d');
            
            const physiologicalChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: [
                        '情绪稳定性',
                        '压力水平',
                        '认知功能',
                        '睡眠质量',
                        '心率变异性'
                    ],
                    datasets: [{
                        label: '用户指标',
                        data: [88, 45, 92, 72, 85],
                        fill: true,
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        pointBackgroundColor: 'rgba(59, 130, 246, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(59, 130, 246, 1)'
                    }, {
                        label: '健康参考值',
                        data: [80, 50, 80, 75, 80],
                        fill: true,
                        backgroundColor: 'rgba(16, 185, 129, 0.2)',
                        borderColor: 'rgba(16, 185, 129, 1)',
                        pointBackgroundColor: 'rgba(16, 185, 129, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(16, 185, 129, 1)'
                    }]
                },
                options: {
                    scales: {
                        r: {
                            angleLines: {
                                display: true
                            },
                            suggestedMin: 0,
                            suggestedMax: 100
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                        }
                    }
                }
            });
        }
        
        // 导航栏滚动效果
        window.addEventListener('scroll', () => {
            const nav = document.querySelector('nav');
            if (window.scrollY > 10) {
                nav.classList.add('py-2');
                nav.classList.remove('py-3');
            } else {
                nav.classList.add('py-3');
                nav.classList.remove('py-2');
            }
        });
        
        // 加载用户资料 - 增强版，优先使用核心同步系统
        async function loadUserProfile(forceUpdate = false) {
            try {
                const syncSystemLogger = { 
                    log: (...args) => console.log(`[AnalysisCenter] ${new Date().toLocaleTimeString()}`, ...args),
                    error: (...args) => console.error(`[AnalysisCenter] ${new Date().toLocaleTimeString()}`, ...args)
                };
                
                syncSystemLogger.log(`加载用户资料${forceUpdate ? '(强制)' : ''}...`);
                
                // 1. 优先使用核心同步系统
                if (window.coreSyncSystem && typeof window.coreSyncSystem.getUserProfile === 'function') {
                    try {
                        const profile = await window.coreSyncSystem.getUserProfile();
                        if (profile) {
                            updateProfileDisplay(profile);
                            syncSystemLogger.log('从核心同步系统加载资料成功');
                            return profile;
                        }
                    } catch (coreError) {
                        syncSystemLogger.error('从核心同步系统加载失败:', coreError);
                        // 继续尝试其他方法
                    }
                }
                
                // 2. 其次使用API获取用户资料
                if (window.apiService && window.apiService.isLoggedIn()) {
                    try {
                        const profile = await window.apiService.getUserProfile();
                        if (profile) {
                            updateProfileDisplay(profile);
                            // 保存到多个存储位置以支持兼容性
                            try {
                                localStorage.setItem('core_user_profile', JSON.stringify(profile));
                                localStorage.setItem('userProfileData', JSON.stringify(profile));
                                localStorage.setItem('currentUser', JSON.stringify(profile));
                            } catch (storageError) {
                                syncSystemLogger.error('保存到localStorage失败:', storageError);
                            }
                            syncSystemLogger.log('从API加载资料成功');
                            return profile;
                        }
                    } catch (apiError) {
                        syncSystemLogger.error('从API加载失败:', apiError);
                        // 继续尝试其他方法
                    }
                }
                
                // 3. 尝试localDB
                if (window.localDB && typeof window.localDB.getUserProfile === 'function') {
                    try {
                        const profile = await window.localDB.getUserProfile();
                        if (profile) {
                            updateProfileDisplay(profile);
                            // 保存到同步存储
                            try {
                                localStorage.setItem('core_user_profile', JSON.stringify(profile));
                                localStorage.setItem('userProfileData', JSON.stringify(profile));
                            } catch (storageError) {
                                syncSystemLogger.error('保存到localStorage失败:', storageError);
                            }
                            syncSystemLogger.log('从localDB加载资料成功');
                            return profile;
                        }
                    } catch (dbError) {
                        syncSystemLogger.error('从localDB加载失败:', dbError);
                    }
                }
                
                // 4. 从localStorage获取 - 尝试多个可能的键
                try {
                    const possibleKeys = ['core_user_profile', 'userProfileData', 'currentUser'];
                    for (const key of possibleKeys) {
                        const syncData = localStorage.getItem(key);
                        if (syncData) {
                            try {
                                const profile = JSON.parse(syncData);
                                updateProfileDisplay(profile);
                                syncSystemLogger.log(`从${key}加载资料成功`);
                                return profile;
                            } catch (parseError) {
                                syncSystemLogger.error(`解析${key}数据失败:`, parseError);
                                // 尝试下一个键
                            }
                        }
                    }
                } catch (storageError) {
                    syncSystemLogger.error('访问localStorage失败:', storageError);
                }
                
                syncSystemLogger.log('所有加载方法都失败');
            } catch (error) {
                console.error('加载用户资料异常:', error);
            }
            return null;
        }
        
        // 更新资料显示
        function updateProfileDisplay(profile) {
            // 设置默认值
            const defaultName = profile.name || profile.fullname || '用户';
            const defaultAvatar = profile.avatar || 'https://picsum.photos/id/91/40/40';
            
            // 更新桌面端导航栏
            const desktopUserDiv = document.querySelector('.hidden.md\:flex.items-center.space-x-6 > div.flex.items-center.space-x-2');
            if (desktopUserDiv) {
                const desktopAvatar = desktopUserDiv.querySelector('img');
                const desktopName = desktopUserDiv.querySelector('span');
                if (desktopAvatar) {
                    desktopAvatar.src = defaultAvatar;
                    desktopAvatar.alt = defaultName;
                }
                if (desktopName) {
                    desktopName.textContent = defaultName;
                }
            }
            
            // 更新移动端导航栏
            const mobileMenu = document.getElementById('mobile-menu');
            if (mobileMenu) {
                const mobileUserDiv = mobileMenu.querySelector('div.flex.items-center.space-x-2');
                if (mobileUserDiv) {
                    const mobileAvatar = mobileUserDiv.querySelector('img');
                    const mobileName = mobileUserDiv.querySelector('span');
                    if (mobileAvatar) {
                        mobileAvatar.src = defaultAvatar;
                        mobileAvatar.alt = defaultName;
                    }
                    if (mobileName) {
                        mobileName.textContent = defaultName;
                    }
                }
            }
        }
        
        // 页面加载完成后初始化
        // 设置用户资料同步监听器 - 增强版，支持核心同步系统
        function setupProfileSyncListener() {
            const syncSystemLogger = { 
                log: (...args) => console.log(`[AnalysisCenter] ${new Date().toLocaleTimeString()}`, ...args),
                error: (...args) => console.error(`[AnalysisCenter] ${new Date().toLocaleTimeString()}`, ...args)
            };
            
            // 统一的资料更新处理函数
            async function handleProfileUpdate() {
                try {
                    await loadUserProfile();
                    syncSystemLogger.log('用户资料已更新');
                } catch (error) {
                    syncSystemLogger.error('处理资料更新失败:', error);
                }
            }
            
            // 监听核心同步系统事件
            window.addEventListener('coreSyncInitialized', () => {
                syncSystemLogger.log('核心同步系统已初始化');
            });
            
            // 监听核心同步系统资料更新事件
            window.addEventListener('coreProfileUpdated', handleProfileUpdate);
            
            // 兼容旧系统事件
            window.addEventListener('ultimateProfileUpdated', handleProfileUpdate);
            window.addEventListener('unifiedProfileUpdated', handleProfileUpdate);
            
            syncSystemLogger.log('已订阅所有资料更新事件');
        }

        // 从localStorage获取登录用户信息
        function getLoggedInUser() {
            try {
                // 优先使用userCredentials键，保持与其他页面一致性
                const credentials = localStorage.getItem('userCredentials');
                if (credentials) {
                    return JSON.parse(credentials);
                }
                // 兼容旧版逻辑
                if (localStorage.getItem('userLoggedIn') === 'true') {
                    const currentUser = localStorage.getItem('currentUser');
                    return currentUser ? JSON.parse(currentUser) : null;
                }
                return null;
            } catch (error) {
                // 静默处理获取失败
                return null;
            }
        }
        
        // 检查用户是否已登录
        function checkLoginStatus() {
            try {
                const user = getLoggedInUser();
                
                // 如果没有登录凭证，重定向到登录页面
                if (!user || !user.username) {
                    window.location.href = 'login.html';
                    return false;
                }
                
                return true;
            } catch (error) {
                window.location.href = 'login.html';
                return false;
            }
        }
        
        document.addEventListener('DOMContentLoaded', async function() {
                // 检查登录状态
                if (!checkLoginStatus()) {
                    // 如果未登录，不执行后续代码
                    return;
                }
                
                const syncSystemLogger = { 
                    log: (...args) => console.log(`[AnalysisCenter] ${new Date().toLocaleTimeString()}`, ...args),
                    error: (...args) => console.error(`[AnalysisCenter] ${new Date().toLocaleTimeString()}`, ...args)
                };
                
                // 使用一个全局变量防止同步过程重复执行
                window._syncInProgress = false;
                
                // 优化的同步函数，优先使用核心同步系统
                async function performSync() {
                    // 防止重复执行
                    if (window._syncInProgress) {
                        syncSystemLogger.log('同步过程正在进行中，跳过此次执行');
                        return;
                    }
                    
                    window._syncInProgress = true;
                    try {
                        syncSystemLogger.log('开始同步数据...');
                        
                        // 优先使用核心同步系统的统一同步方法
                        if (window.coreSyncSystem && typeof window.coreSyncSystem.syncAllData === 'function') {
                            try {
                                await window.coreSyncSystem.syncAllData();
                                syncSystemLogger.log('核心同步系统同步完成');
                                return;
                            } catch (coreSyncError) {
                                syncSystemLogger.error('核心同步系统同步失败，尝试备选方案:', coreSyncError);
                                // 继续尝试其他方案
                            }
                        }
                        
                        // 如果核心同步系统不可用或失败，尝试单独同步
                        try {
                            await loadUserProfile();
                        } catch (profileError) {
                            syncSystemLogger.error('同步用户资料失败:', profileError);
                        }
                        
                        syncSystemLogger.log('同步完成');
                    } finally {
                        // 无论成功失败，都要重置同步状态标志
                        window._syncInProgress = false;
                    }
                }
                
                // 激活用户资料同步监听器
                setupProfileSyncListener();
                
                // 初始化时尝试同步
                try {
                    // 优先使用核心同步系统
                    if (window.coreSyncSystem && typeof window.coreSyncSystem.syncAllData === 'function') {
                        syncSystemLogger.log('使用核心同步系统同步数据');
                        await window.coreSyncSystem.syncAllData();
                    } else if (window.userProfileSync && typeof window.userProfileSync.syncProfileData === 'function') {
                        syncSystemLogger.log('使用userProfileSync同步用户资料');
                        await window.userProfileSync.syncProfileData();
                    } else if (window.ultimateSyncSystem && typeof window.ultimateSyncSystem.syncUserProfile === 'function') {
                        syncSystemLogger.log('使用ultimateSyncSystem同步用户资料');
                        await window.ultimateSyncSystem.syncUserProfile();
                    } else {
                        syncSystemLogger.log('使用备用同步逻辑');
                        await loadUserProfile();
                    }
                } catch (syncError) {
                    syncSystemLogger.error('初始化同步失败，将使用备用加载:', syncError);
                    try {
                        await loadUserProfile();
                    } catch (loadError) {
                        syncSystemLogger.error('备用加载也失败:', loadError);
                    }
                }
                
                // 设置定期同步以确保数据最新，所有情况下都适用
                const syncIntervalId = setInterval(() => {
                    // 异步执行，不阻塞定时器
                    performSync().catch(error => {
                        syncSystemLogger.error('定时器同步失败:', error);
                    });
                }, 60000); // 延长到60秒，减少同步频率
                
                // 添加页面卸载时清理定时器
                window.addEventListener('beforeunload', () => {
                    clearInterval(syncIntervalId);
                    syncSystemLogger.log('已清理同步定时器');
                });
                
                // 监听localStorage变化，实现跨页面同步 - 增强版
                window.addEventListener('storage', (e) => {
                    // 包含核心同步系统的存储键
                    const relevantKeys = [
                        'core_user_profile', 'analysisHistory', 
                        'userCredentials', 'userProfileData', 
                        'currentUser', 'core_sync_timestamp'
                    ];
                    
                    if (relevantKeys.includes(e.key)) {
                        syncSystemLogger.log(`检测到localStorage变化: ${e.key}`);
                        
                        // 延迟执行以确保数据写入完成
                        setTimeout(() => {
                            try {
                                // 防止重复执行
                                if (window._syncInProgress) {
                                    syncSystemLogger.log('同步进行中，跳过storage事件同步');
                                    return;
                                }
                                
                                // 对于核心同步系统的变更，直接使用performSync
                                if (e.key === 'core_user_profile' || e.key === 'core_sync_timestamp') {
                                    performSync();
                                } else if (e.key === 'analysisHistory') {
                                    // 历史记录变化
                                    try {
                                        // 触发自定义事件通知分析中心更新
                                        const event = new CustomEvent('analysisHistoryUpdated', {
                                            detail: { source: 'localStorage' }
                                        });
                                        window.dispatchEvent(event);
                                        // 同时触发核心同步系统的事件
                                        const coreEvent = new CustomEvent('coreAnalysisHistoryUpdated', {
                                            detail: { source: 'localStorage' }
                                        });
                                        window.dispatchEvent(coreEvent);
                                    } catch (eventError) {
                                        syncSystemLogger.error('触发历史更新事件失败:', eventError);
                                    }
                                } else {
                                    // 用户资料相关变化
                                    loadUserProfile().catch(err => 
                                        syncSystemLogger.error('storage事件同步用户资料失败:', err)
                                    );
                                }
                            } catch (error) {
                                syncSystemLogger.error('处理storage事件失败:', error);
                            }
                        }, 200); // 稍微延长延迟，确保数据完全写入
                    }
                });
                
                // 监听页面可见性变化，当页面重新可见时同步数据 - 优化版
                document.addEventListener('visibilitychange', () => {
                    if (document.visibilityState === 'visible') {
                        syncSystemLogger.log('页面重新可见，准备同步数据');
                        
                        // 使用优化的同步函数，避免重复代码
                        performSync().catch(error => {
                            syncSystemLogger.error('页面可见性同步失败:', error);
                        });
                    }
                });
                
                // 导出关键函数供调试使用
                window._analysisSyncDebug = {
                    performSync,
                    loadUserProfile,
                    logger: syncSystemLogger
                };
            });
    </script>
</body>
</html>