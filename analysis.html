<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ‘éƒç—‡åˆ†æç³»ç»Ÿ - åˆ†æä¸­å¿ƒ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <script src="localdb.js"></script>
    <script src="sync_user_profile.js"></script>
    <script src="ultimate_sync_fix.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#6366f1',
                        accent: '#8b5cf6',
                        dark: '#1e293b',
                        light: '#f8fafc',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444',
                        info: '#06b6d4',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                },
            }
        }
    </script>
    <style>
        .content-auto { content-visibility: auto; }
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); }
        .hover-scale { transition: transform 0.2s; }
        .hover-scale:hover { transform: scale(1.05); }
        .file-drop-area { border: 2px dashed #d1d5db; border-radius: 0.5rem; padding: 2rem; text-align: center; cursor: pointer; transition: all 0.2s; }
        .file-drop-area:hover { border-color: #3b82f6; background-color: rgba(59,130,246,0.05); }
        .model-card-active { border-color: #3b82f6; background-color: rgba(59,130,246,0.05); }
    </style>
</head>
<body class="bg-gray-50 font-sans min-h-screen">
    <nav class="bg-white shadow-md fixed top-0 left-0 right-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fa fa-heartbeat text-primary text-2xl"></i>
                <span class="text-xl font-bold text-dark">æŠ‘éƒç—‡åˆ†æç³»ç»Ÿ</span>
            </div>
            <div class="hidden md:flex items-center space-x-6">
                <a href="index.html" class="text-gray-600 hover:text-primary transition-colors">é¦–é¡µ</a>
                <a href="analysis.html" class="text-primary font-medium">åˆ†æä¸­å¿ƒ</a>
                <a href="user_center.html" class="text-gray-600 hover:text-primary transition-colors">ç”¨æˆ·ä¸­å¿ƒ</a>
                <div class="flex items-center space-x-2">
                        <img src="https://picsum.photos/id/91/40/40" alt="ç”¨æˆ·å¤´åƒ" id="nav-avatar-desktop" class="w-10 h-10 rounded-full object-cover border-2 border-primary">
                        <span id="nav-username-desktop" class="text-gray-700 font-medium">å‘¨å…‰æ³½</span>
                    </div>
                <a href="login.html" class="text-gray-600 hover:text-danger transition-colors">
                    <i class="fa fa-sign-out"></i> é€€å‡º
                </a>
            </div>
            <div class="md:hidden">
                <button id="menu-toggle" class="text-gray-600 hover:text-primary focus:outline-none">
                    <i class="fa fa-bars text-xl"></i>
                </button>
            </div>
        </div>
        <div id="mobile-menu" class="hidden md:hidden bg-white px-4 py-2 shadow-lg">
            <a href="index.html" class="block py-2 text-gray-600 hover:text-primary">é¦–é¡µ</a>
            <a href="analysis.html" class="block py-2 text-primary font-medium">åˆ†æä¸­å¿ƒ</a>
            <a href="user_center.html" class="block py-2 text-gray-600 hover:text-primary">ç”¨æˆ·ä¸­å¿ƒ</a>
            <div class="py-2 flex items-center space-x-2 border-t border-gray-100">
                    <img src="https://picsum.photos/id/91/40/40" alt="ç”¨æˆ·å¤´åƒ" id="nav-avatar-mobile" class="w-8 h-8 rounded-full object-cover border-2 border-primary">
                        <span id="nav-username-mobile" class="text-gray-700 font-medium">å‘¨å…‰æ³½</span>
                </div>
            <a href="login.html" class="block py-2 text-danger font-medium border-t border-gray-100">
                <i class="fa fa-sign-out mr-2"></i> é€€å‡º
            </a>
        </div>
    </nav>

    <main class="container mx-auto px-4 pt-24 pb-16">
        <div class="mb-8">
            <h1 class="text-2xl md:text-3xl font-bold text-dark mb-2">åˆ†æä¸­å¿ƒ</h1>
            <p class="text-gray-500">ä¸Šä¼ å¿ƒç”µè„‘ç”µæ•°æ®ï¼Œè·å–ä¸“ä¸šçš„å¿ƒç†å¥åº·è¯„ä¼°</p>
        </div>
        
        <div class="flex justify-between items-center mb-8">
            <div class="flex flex-col items-center">
                <div class="w-12 h-12 bg-primary text-white rounded-full flex items-center justify-center text-xl font-bold mb-2">1</div>
                <span class="text-sm text-primary font-medium">ä¸Šä¼ æ•°æ®</span>
            </div>
            <div class="flex-1 h-1 bg-primary mx-4"></div>
            <div class="flex flex-col items-center">
                <div class="w-12 h-12 bg-gray-200 text-gray-500 rounded-full flex items-center justify-center text-xl font-bold mb-2">2</div>
                <span class="text-sm text-gray-500">é€‰æ‹©æ¨¡å‹</span>
            </div>
            <div class="flex-1 h-1 bg-gray-200 mx-4"></div>
            <div class="flex flex-col items-center">
                <div class="w-12 h-12 bg-gray-200 text-gray-500 rounded-full flex items-center justify-center text-xl font-bold mb-2">3</div>
                <span class="text-sm text-gray-500">åˆ†æç»“æœ</span>
            </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 space-y-8">
                <div class="bg-white rounded-xl card-shadow p-6">
                    <h3 class="text-lg font-semibold text-dark mb-6">æ•°æ®ä¸Šä¼ </h3>
                    
                    <div id="file-drop-area" class="file-drop-area mb-6">
                        <i class="fa fa-cloud-upload text-4xl text-gray-400 mb-4"></i>
                        <h4 class="text-lg font-medium text-gray-700 mb-2">æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ </h4>
                        <p class="text-sm text-gray-500 mb-4">æ”¯æŒæ ¼å¼ï¼šCSV, JSON, TXT</p>
                        <label for="file-input" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-md cursor-pointer transition-colors inline-flex items-center">
                            <i class="fa fa-folder-open-o mr-2"></i> é€‰æ‹©æ–‡ä»¶
                        </label>
                        <input id="file-input" type="file" accept=".csv,.json,.txt" class="hidden">
                    </div>
                    
                    <div id="selected-file" class="hidden mb-6">
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200">
                            <div class="flex items-center">
                                <i class="fa fa-file-text-o text-primary text-xl mr-3"></i>
                                <span id="file-name" class="text-gray-700 truncate max-w-xs">sample_data.csv</span>
                            </div>
                            <button id="remove-file" class="text-gray-400 hover:text-danger transition-colors">
                                <i class="fa fa-times text-lg"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">æ•°æ®ç±»å‹</label>
                        <div class="grid grid-cols-2 gap-4">
                            <label class="flex items-center p-3 border border-gray-300 rounded-lg cursor-pointer hover:border-primary transition-colors">
                                <input type="radio" name="data-type" value="ecg" class="h-4 w-4 text-primary focus:ring-primary border-gray-300">
                                <span class="ml-2 text-gray-700">å¿ƒç”µå›¾æ•°æ®</span>
                            </label>
                            <label class="flex items-center p-3 border border-gray-300 rounded-lg cursor-pointer hover:border-primary transition-colors">
                                <input type="radio" name="data-type" value="eeg" class="h-4 w-4 text-primary focus:ring-primary border-gray-300">
                                <span class="ml-2 text-gray-700">è„‘ç”µå›¾æ•°æ®</span>
                            </label>
                        </div>
                    </div>
                    
                    <button id="next-step-btn" class="w-full bg-primary hover:bg-primary/90 text-white font-medium py-3 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <span>ä¸‹ä¸€æ­¥ï¼šé€‰æ‹©æ¨¡å‹</span>
                        <i class="fa fa-arrow-right"></i>
                    </button>
                </div>
                
                <div id="model-selection-card" class="bg-white rounded-xl card-shadow p-6 hidden">
                    <h3 class="text-lg font-semibold text-dark mb-6">é€‰æ‹©åˆ†ææ¨¡å‹</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div id="svm-model" class="border-2 border-gray-300 hover:border-primary rounded-lg p-6 cursor-pointer transition-all duration-200">
                            <div class="flex justify-between items-start mb-4">
                                <div class="w-12 h-12 bg-primary/10 rounded-full flex items-center justify-center">
                                    <i class="fa fa-line-chart text-primary text-xl"></i>
                                </div>
                                <input type="radio" name="model" value="svm" class="h-5 w-5 text-primary focus:ring-primary border-gray-300">
                            </div>
                            <h4 class="text-xl font-semibold text-dark mb-2">SVMæ¨¡å‹</h4>
                            <p class="text-gray-600 mb-4">æ”¯æŒå‘é‡æœºæ¨¡å‹ï¼Œé€‚åˆé«˜ç»´æ•°æ®åˆ†ç±»ï¼Œåœ¨ç‰¹å¾æ˜æ˜¾æ—¶å‡†ç¡®æ€§é«˜ã€‚</p>
                            <div class="flex justify-between items-center text-sm">
                                <span class="text-gray-500">å‡†ç¡®ç‡: <span class="font-medium text-primary">92%</span></span>
                                <span class="text-gray-500">å¤„ç†é€Ÿåº¦: <span class="font-medium text-primary">è¾ƒå¿«</span></span>
                            </div>
                        </div>
                        
                        <div id="random-forest-model" class="border-2 border-gray-300 hover:border-primary rounded-lg p-6 cursor-pointer transition-all duration-200">
                            <div class="flex justify-between items-start mb-4">
                                <div class="w-12 h-12 bg-secondary/10 rounded-full flex items-center justify-center">
                                    <i class="fa fa-tree text-secondary text-xl"></i>
                                </div>
                                <input type="radio" name="model" value="random-forest" class="h-5 w-5 text-primary focus:ring-primary border-gray-300">
                            </div>
                            <h4 class="text-xl font-semibold text-dark mb-2">éšæœºæ£®æ—</h4>
                            <p class="text-gray-600 mb-4">é›†æˆå­¦ä¹ ç®—æ³•ï¼Œå¯¹å™ªå£°æ•°æ®æœ‰è¾ƒå¥½çš„é²æ£’æ€§ï¼Œé€‚åˆå¤æ‚ç‰¹å¾åˆ†æã€‚</p>
                            <div class="flex justify-between items-center text-sm">
                                <span class="text-gray-500">å‡†ç¡®ç‡: <span class="font-medium text-secondary">94%</span></span>
                                <span class="text-gray-500">å¤„ç†é€Ÿåº¦: <span class="font-medium text-secondary">ä¸­ç­‰</span></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row gap-4">
                        <button id="back-to-upload" class="flex-1 bg-white hover:bg-gray-50 text-primary border border-primary px-4 py-3 rounded-lg transition-colors duration-200 flex items-center justify-center">
                            <i class="fa fa-arrow-left mr-2"></i>
                            <span>è¿”å›ä¸Šä¼ </span>
                        </button>
                        <button id="start-analysis-btn" class="flex-1 bg-primary hover:bg-primary/90 text-white font-medium py-3 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <span>å¼€å§‹åˆ†æ</span>
                            <i class="fa fa-play"></i>
                        </button>
                    </div>
                </div>
                
                <div id="analysis-result-card" class="bg-white rounded-xl card-shadow p-6 hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-semibold text-dark">åˆ†æç»“æœ</h3>
                        <div class="flex space-x-2">
                            <button class="text-gray-500 hover:text-gray-700 transition-colors">
                                <i class="fa fa-download mr-1"></i> ä¸‹è½½æŠ¥å‘Š
                            </button>
                            <button class="text-gray-500 hover:text-gray-700 transition-colors">
                                <i class="fa fa-share-alt mr-1"></i> åˆ†äº«
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-gray-50 rounded-xl p-6 text-center">
                            <h4 class="text-gray-600 mb-2">å¿ƒç†å¥åº·æŒ‡æ•°</h4>
                            <div class="text-4xl font-bold text-primary mb-2">85</div>
                            <div class="text-sm text-success font-medium">è‰¯å¥½çŠ¶æ€</div>
                        </div>
                        
                        <div class="bg-gray-50 rounded-xl p-6 text-center">
                            <h4 class="text-gray-600 mb-2">ä½¿ç”¨æ¨¡å‹</h4>
                            <div class="text-2xl font-bold text-dark mb-2">SVMæ¨¡å‹</div>
                            <div class="text-sm text-gray-500">ç½®ä¿¡åº¦: 92%</div>
                        </div>
                        
                        <div class="bg-gray-50 rounded-xl p-6 text-center">
                            <h4 class="text-gray-600 mb-2">åˆ†ææ—¶é—´</h4>
                            <div class="text-xl font-bold text-dark mb-2">2023-07-28</div>
                            <div class="text-sm text-gray-500">15:30:45</div>
                        </div>
                    </div>
                    
                    <div class="mb-8">
                        <h4 class="text-lg font-semibold text-dark mb-4">è¯¦ç»†åˆ†æ</h4>
                        <div class="space-y-4">
                            <div>
                                <div class="flex justify-between mb-2">
                                    <span class="text-gray-600">æƒ…ç»ªç¨³å®šæ€§</span>
                                    <span class="font-medium text-primary">88%</span>
                                </div>
                                <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                                    <div class="h-full bg-primary rounded-full" style="width: 88%"></div>
                                </div>
                            </div>
                            
                            <div>
                                <div class="flex justify-between mb-2">
                                    <span class="text-gray-600">å‹åŠ›æ°´å¹³</span>
                                    <span class="font-medium text-success">45%</span>
                                </div>
                                <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                                    <div class="h-full bg-success rounded-full" style="width: 45%"></div>
                                </div>
                            </div>
                            
                            <div>
                                <div class="flex justify-between mb-2">
                                    <span class="text-gray-600">è®¤çŸ¥åŠŸèƒ½</span>
                                    <span class="font-medium text-info">92%</span>
                                </div>
                                <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                                    <div class="h-full bg-info rounded-full" style="width: 92%"></div>
                                </div>
                            </div>
                            
                            <div>
                                <div class="flex justify-between mb-2">
                                    <span class="text-gray-600">ç¡çœ è´¨é‡</span>
                                    <span class="font-medium text-warning">72%</span>
                                </div>
                                <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                                    <div class="h-full bg-warning rounded-full" style="width: 72%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-8">
                        <h4 class="text-lg font-semibold text-dark mb-4">å¥åº·å»ºè®®</h4>
                        <div class="bg-blue-50 border-l-4 border-primary p-4 rounded">
                            <p class="text-gray-700 mb-3">
                                æ ¹æ®æ‚¨çš„åˆ†æç»“æœï¼Œæ‚¨çš„å¿ƒç†å¥åº·çŠ¶æ€è‰¯å¥½ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å»ºè®®å¸®åŠ©æ‚¨ç»´æŒè‰¯å¥½çŠ¶æ€ï¼š
                            </p>
                            <ul class="text-gray-700 space-y-2">
                                <li class="flex items-start">
                                    <i class="fa fa-check-circle text-primary mt-1 mr-2"></i>
                                    <span>ä¿æŒè§„å¾‹çš„ä½œæ¯æ—¶é—´ï¼Œæ¯å¤©ä¿è¯7-8å°æ—¶ç¡çœ </span>
                                </li>
                                <li class="flex items-start">
                                    <i class="fa fa-check-circle text-primary mt-1 mr-2"></i>
                                    <span>æ¯å‘¨è¿›è¡Œè‡³å°‘150åˆ†é’Ÿä¸­ç­‰å¼ºåº¦çš„ä½“è‚²é”»ç‚¼</span>
                                </li>
                                <li class="flex items-start">
                                    <i class="fa fa-check-circle text-primary mt-1 mr-2"></i>
                                    <span>ä¿æŒå¥åº·å‡è¡¡çš„é¥®é£Ÿï¼Œå‡å°‘å’–å•¡å› å’Œé…’ç²¾æ‘„å…¥</span>
                                </li>
                                <li class="flex items-start">
                                    <i class="fa fa-check-circle text-primary mt-1 mr-2"></i>
                                    <span>å»ºè®®æ¯ä¸¤å‘¨è¿›è¡Œä¸€æ¬¡å¿ƒç†å¥åº·ç›‘æµ‹ï¼Œè®°å½•æƒ…ç»ªå˜åŒ–</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row gap-4">
                        <button id="new-analysis-btn" class="flex-1 bg-primary hover:bg-primary/90 text-white font-medium py-3 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center">
                            <i class="fa fa-plus mr-2"></i>
                            <span>æ–°å»ºåˆ†æ</span>
                        </button>
                        <button id="view-history-btn" class="flex-1 bg-white hover:bg-gray-50 text-primary border border-primary px-4 py-3 rounded-lg transition-colors duration-200 flex items-center justify-center">
                            <i class="fa fa-history mr-2"></i>
                            <span>æŸ¥çœ‹å†å²</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="lg:col-span-1">
                <div class="bg-white rounded-xl card-shadow p-6 sticky top-24">
                    <h3 class="text-lg font-semibold text-dark mb-6">ç”Ÿç†æŒ‡æ ‡é›·è¾¾å›¾</h3>
                    
                    <div class="h-72 mb-6">
                        <canvas id="physiologicalChart"></canvas>
                    </div>
                    
                    <div class="space-y-4">
                        <h4 class="font-medium text-gray-700 mb-2">å‚è€ƒæ ‡å‡†</h4>
                        <div class="flex items-center text-sm mb-1">
                            <span class="w-3 h-3 bg-danger rounded-full mr-2"></span>
                            <span class="text-gray-600">éœ€å…³æ³¨ (&lt; 60)</span>
                        </div>
                        <div class="flex items-center text-sm mb-1">
                            <span class="w-3 h-3 bg-warning rounded-full mr-2"></span>
                            <span class="text-gray-600">ä¸€èˆ¬ (60-79)</span>
                        </div>
                        <div class="flex items-center text-sm">
                            <span class="w-3 h-3 bg-success rounded-full mr-2"></span>
                            <span class="text-gray-600">è‰¯å¥½ (â‰¥ 80)</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-dark text-gray-300 py-8">
        <div class="container mx-auto px-4 text-center">
            <p class="mb-4"><i class="fa fa-heartbeat text-primary mr-2"></i>æŠ‘éƒç—‡åˆ†æç³»ç»Ÿ - å…³æ³¨å¿ƒç†å¥åº·ï¼Œç§‘å­¦é¢„é˜²æŠ‘éƒç—‡</p>
            <div class="flex justify-center space-x-6 mb-4">
                <a href="#" class="text-gray-400 hover:text-white transition-colors">
                    <i class="fa fa-weixin text-xl"></i>
                </a>
                <a href="#" class="text-gray-400 hover:text-white transition-colors">
                    <i class="fa fa-weibo text-xl"></i>
                </a>
                <a href="#" class="text-gray-400 hover:text-white transition-colors">
                    <i class="fa fa-qq text-xl"></i>
                </a>
            </div>
            <p class="text-sm text-gray-500">&copy; 2023 æŠ‘éƒç—‡åˆ†æç³»ç»Ÿ. ä¿ç•™æ‰€æœ‰æƒåˆ©.</p>
        </div>
    </footer>

    <script>
        // ç§»åŠ¨ç«¯èœå•åˆ‡æ¢
        const menuToggle = document.getElementById('menu-toggle');
        const mobileMenu = document.getElementById('mobile-menu');
        
        menuToggle.addEventListener('click', () => {
            mobileMenu.classList.toggle('hidden');
        });
        
        // æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
        const fileDropArea = document.getElementById('file-drop-area');
        const fileInput = document.getElementById('file-input');
        const selectedFile = document.getElementById('selected-file');
        const fileName = document.getElementById('file-name');
        const removeFile = document.getElementById('remove-file');
        const nextStepBtn = document.getElementById('next-step-btn');
        const dataTypeRadios = document.querySelectorAll('input[name="data-type"]');
        
        // æ–‡ä»¶æ‹–æ”¾åŠŸèƒ½
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            fileDropArea.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            fileDropArea.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            fileDropArea.addEventListener(eventName, unhighlight, false);
        });
        
        function highlight() {
            fileDropArea.classList.add('border-primary', 'bg-primary/5');
        }
        
        function unhighlight() {
            fileDropArea.classList.remove('border-primary', 'bg-primary/5');
        }
        
        // å¤„ç†æ–‡ä»¶æ‹–æ”¾
        fileDropArea.addEventListener('drop', handleDrop, false);
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length) {
                handleFiles(files[0]);
            }
        }
        
        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        fileInput.addEventListener('change', function() {
            if (this.files.length) {
                handleFiles(this.files[0]);
            }
        });
        
        function handleFiles(file) {
            // å­˜å‚¨ä¸Šä¼ çš„æ–‡ä»¶åˆ°å…¨å±€å˜é‡
            uploadedFile = file;
            // æ˜¾ç¤ºé€‰ä¸­çš„æ–‡ä»¶
            fileName.textContent = file.name;
            selectedFile.classList.remove('hidden');
            
            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            const validExtensions = ['.csv', '.json', '.txt'];
            const isValidType = validExtensions.some(ext => 
                file.name.toLowerCase().endsWith(ext)
            );
            
            if (!isValidType) {
                alert('è¯·ä¸Šä¼ CSVã€JSONæˆ–TXTæ ¼å¼çš„æ–‡ä»¶');
                removeFile.click();
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†æ•°æ®ç±»å‹
            checkEnableNextButton();
        }
        
        // ç§»é™¤æ–‡ä»¶
        removeFile.addEventListener('click', function() {
            selectedFile.classList.add('hidden');
            fileInput.value = '';
            checkEnableNextButton();
        });
        
        // ç›‘å¬æ•°æ®ç±»å‹é€‰æ‹©å˜åŒ–
        dataTypeRadios.forEach(radio => {
            radio.addEventListener('change', checkEnableNextButton);
        });
        
        // æ£€æŸ¥æ˜¯å¦å¯ä»¥å¯ç”¨ä¸‹ä¸€æ­¥æŒ‰é’®
        function checkEnableNextButton() {
            const hasFile = !selectedFile.classList.contains('hidden');
            const hasDataType = Array.from(dataTypeRadios).some(radio => radio.checked);
            
            nextStepBtn.disabled = !(hasFile && hasDataType);
        }
        
        // æ¨¡å‹é€‰æ‹©åŠŸèƒ½
        const modelSelectionCard = document.getElementById('model-selection-card');
        const svmModel = document.getElementById('svm-model');
        const randomForestModel = document.getElementById('random-forest-model');
        const modelRadios = document.querySelectorAll('input[name="model"]');
        const startAnalysisBtn = document.getElementById('start-analysis-btn');
        const backToUpload = document.getElementById('back-to-upload');
        const analysisResultCard = document.getElementById('analysis-result-card');
        const stepIndicators = document.querySelectorAll('.flex-col.items-center');
        
        // ä¸‹ä¸€æ­¥æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        nextStepBtn.addEventListener('click', function() {
            // æ˜¾ç¤ºæ¨¡å‹é€‰æ‹©å¡ç‰‡
            modelSelectionCard.classList.remove('hidden');
            
            // æ›´æ–°æ­¥éª¤æŒ‡ç¤ºå™¨
            stepIndicators[1].querySelector('div').classList.remove('bg-gray-200', 'text-gray-500');
            stepIndicators[1].querySelector('div').classList.add('bg-primary', 'text-white');
            stepIndicators[1].querySelector('span').classList.remove('text-gray-500');
            stepIndicators[1].querySelector('span').classList.add('text-primary', 'font-medium');
            stepIndicators[0].querySelector('div').classList.remove('bg-primary', 'text-white');
            stepIndicators[0].querySelector('div').classList.add('bg-gray-200', 'text-gray-500');
            stepIndicators[0].querySelector('span').classList.remove('text-primary', 'font-medium');
            stepIndicators[0].querySelector('span').classList.add('text-gray-500');
            stepIndicators[0].nextElementSibling.classList.remove('bg-primary');
            stepIndicators[0].nextElementSibling.classList.add('bg-gray-200');
        });
        
        // è¿”å›ä¸Šä¼ æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        backToUpload.addEventListener('click', function() {
            // éšè—æ¨¡å‹é€‰æ‹©å¡ç‰‡
            modelSelectionCard.classList.add('hidden');
            
            // é‡ç½®æ¨¡å‹é€‰æ‹©
            modelRadios.forEach(radio => radio.checked = false);
            svmModel.classList.remove('model-card-active');
            randomForestModel.classList.remove('model-card-active');
            startAnalysisBtn.disabled = true;
            
            // æ›´æ–°æ­¥éª¤æŒ‡ç¤ºå™¨
            stepIndicators[1].querySelector('div').classList.remove('bg-primary', 'text-white');
            stepIndicators[1].querySelector('div').classList.add('bg-gray-200', 'text-gray-500');
            stepIndicators[1].querySelector('span').classList.remove('text-primary', 'font-medium');
            stepIndicators[1].querySelector('span').classList.add('text-gray-500');
            stepIndicators[0].querySelector('div').classList.remove('bg-gray-200', 'text-gray-500');
            stepIndicators[0].querySelector('div').classList.add('bg-primary', 'text-white');
            stepIndicators[0].querySelector('span').classList.remove('text-gray-500');
            stepIndicators[0].querySelector('span').classList.add('text-primary', 'font-medium');
            stepIndicators[0].nextElementSibling.classList.remove('bg-gray-200');
            stepIndicators[0].nextElementSibling.classList.add('bg-primary');
        });
        
        // ç‚¹å‡»æ¨¡å‹å¡ç‰‡é€‰æ‹©æ¨¡å‹
        svmModel.addEventListener('click', function() {
            document.querySelector('input[name="model"][value="svm"]').checked = true;
            svmModel.classList.add('model-card-active');
            randomForestModel.classList.remove('model-card-active');
            startAnalysisBtn.disabled = false;
        });
        
        randomForestModel.addEventListener('click', function() {
            document.querySelector('input[name="model"][value="random-forest"]').checked = true;
            randomForestModel.classList.add('model-card-active');
            svmModel.classList.remove('model-card-active');
            startAnalysisBtn.disabled = false;
        });
        
        // å…¨å±€å˜é‡å­˜å‚¨ä¸Šä¼ çš„æ–‡ä»¶
        let uploadedFile = null;
        
        // å¼€å§‹åˆ†ææŒ‰é’®ç‚¹å‡»äº‹ä»¶
        startAnalysisBtn.addEventListener('click', function() {
            // ç¡®ä¿æœ‰ä¸Šä¼ çš„æ–‡ä»¶
            if (!uploadedFile) {
                alert('è¯·å…ˆä¸Šä¼ æ•°æ®æ–‡ä»¶');
                return;
            }
            
            // ç¡®ä¿æœ‰é€‰æ‹©çš„æ¨¡å‹
            const selectedModelRadio = document.querySelector('input[name="model"]:checked');
            if (!selectedModelRadio) {
                alert('è¯·é€‰æ‹©ä¸€ä¸ªåˆ†ææ¨¡å‹');
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            this.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>åˆ†æä¸­...';
            this.disabled = true;
            
            // è·å–é€‰æ‹©çš„æ¨¡å‹
            const selectedModel = selectedModelRadio.value;
            
            // æ¨¡æ‹Ÿåˆ†æè¿‡ç¨‹
            setTimeout(function() {
                // éšè—æ¨¡å‹é€‰æ‹©å¡ç‰‡
                modelSelectionCard.classList.add('hidden');
                
                // æ˜¾ç¤ºåˆ†æç»“æœå¡ç‰‡
                analysisResultCard.classList.remove('hidden');
                
                // æ›´æ–°æ­¥éª¤æŒ‡ç¤ºå™¨
                stepIndicators[2].querySelector('div').classList.remove('bg-gray-200', 'text-gray-500');
                stepIndicators[2].querySelector('div').classList.add('bg-primary', 'text-white');
                stepIndicators[2].querySelector('span').classList.remove('text-gray-500');
                stepIndicators[2].querySelector('span').classList.add('text-primary', 'font-medium');
                stepIndicators[1].querySelector('div').classList.remove('bg-primary', 'text-white');
                stepIndicators[1].querySelector('div').classList.add('bg-gray-200', 'text-gray-500');
                stepIndicators[1].querySelector('span').classList.remove('text-primary', 'font-medium');
                stepIndicators[1].querySelector('span').classList.add('text-gray-500');
                stepIndicators[1].nextElementSibling.classList.remove('bg-gray-200');
                stepIndicators[1].nextElementSibling.classList.add('bg-primary');
                
                // æ ¹æ®é€‰æ‹©çš„æ¨¡å‹æ›´æ–°ç»“æœæ•°æ®
                updateAnalysisResults(selectedModel);
                
                // åˆå§‹åŒ–ç”Ÿç†æŒ‡æ ‡é›·è¾¾å›¾
                initPhysiologicalChart();
                
            }, 2000);
        });
        
        // æ ¹æ®é€‰æ‹©çš„æ¨¡å‹æ›´æ–°åˆ†æç»“æœ
        function updateAnalysisResults(model) {
            // è·å–å½“å‰æ—¥æœŸæ—¶é—´
            const now = new Date();
            const date = now.toLocaleDateString('zh-CN');
            const time = now.toLocaleTimeString('zh-CN');
            
            // æ ¹æ®é€‰æ‹©çš„æ¨¡å‹è®¾ç½®ä¸åŒçš„ç»“æœæ•°æ®
            let modelName, confidence, healthIndex, details, advice;
            
            if (model === 'svm') {
                modelName = 'SVMæ¨¡å‹';
                confidence = '92%';
                healthIndex = 85;
                details = {
                    'æƒ…ç»ªç¨³å®šæ€§': 88,
                    'å‹åŠ›æ°´å¹³': 45,
                    'è®¤çŸ¥åŠŸèƒ½': 92,
                    'ç¡çœ è´¨é‡': 72
                };
                advice = 'æ ¹æ®æ‚¨çš„åˆ†æç»“æœï¼Œæ‚¨çš„å¿ƒç†å¥åº·çŠ¶æ€è‰¯å¥½ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å»ºè®®å¸®åŠ©æ‚¨ç»´æŒè‰¯å¥½çŠ¶æ€ï¼š';
            } else {
                modelName = 'éšæœºæ£®æ—';
                confidence = '94%';
                healthIndex = 87;
                details = {
                    'æƒ…ç»ªç¨³å®šæ€§': 90,
                    'å‹åŠ›æ°´å¹³': 42,
                    'è®¤çŸ¥åŠŸèƒ½': 95,
                    'ç¡çœ è´¨é‡': 70
                };
                advice = 'éšæœºæ£®æ—æ¨¡å‹åˆ†æç»“æœæ˜¾ç¤ºæ‚¨çš„å¿ƒç†å¥åº·çŠ¶æ€è‰¯å¥½ã€‚ä»¥ä¸‹æ˜¯ä¸“ä¸šå»ºè®®å¸®åŠ©æ‚¨ç»´æŒå’Œæ”¹å–„ï¼š';
            }
            
            // æ›´æ–°ç»“æœæ˜¾ç¤º
            document.querySelector('.text-4xl.font-bold.text-primary').textContent = healthIndex;
            document.querySelector('.text-2xl.font-bold.text-dark').textContent = modelName;
            document.querySelector('.text-sm.text-gray-500').textContent = `ç½®ä¿¡åº¦: ${confidence}`;
            document.querySelector('.text-xl.font-bold.text-dark.mb-2').textContent = date;
            document.querySelector('.text-sm.text-gray-500').nextElementSibling.textContent = time;
            
            // æ›´æ–°è¯¦ç»†åˆ†ææ•°æ®
            const detailItems = document.querySelectorAll('.space-y-4 > div');
            let index = 0;
            for (const [key, value] of Object.entries(details)) {
                if (index < detailItems.length) {
                    detailItems[index].querySelector('span.text-gray-600').textContent = key;
                    detailItems[index].querySelector('span.font-medium').textContent = `${value}%`;
                    detailItems[index].querySelector('.h-full').style.width = `${value}%`;
                    index++;
                }
            }
            
            // æ›´æ–°å¥åº·å»ºè®®
            document.querySelector('.bg-blue-50.border-l-4.border-primary.p-4.rounded p:first-child').textContent = advice;
            
            // ä¿å­˜ç»“æœåˆ°localStorageï¼Œç”¨äºåŒæ­¥åˆ°å†å²è®°å½•
            const resultData = {
                date: date,
                model: modelName,
                healthIndex: healthIndex,
                confidence: confidence,
                details: details,
                advice: advice,
                timestamp: now.getTime()
            };
            
            // è·å–ç°æœ‰çš„å†å²è®°å½•æˆ–åˆ›å»ºæ–°æ•°ç»„
            let historyRecords = JSON.parse(localStorage.getItem('analysisHistory')) || [];
            
            // æ·»åŠ æ–°è®°å½•åˆ°å¼€å¤´
            historyRecords.unshift(resultData);
            
            // é™åˆ¶å†å²è®°å½•æ•°é‡ï¼Œæœ€å¤šä¿å­˜100æ¡
            if (historyRecords.length > 100) {
                historyRecords = historyRecords.slice(0, 100);
            }
            
            // ä¿å­˜å›localStorage
            localStorage.setItem('analysisHistory', JSON.stringify(historyRecords));
            
            // ç›´æ¥ä¿å­˜åˆ°IndexedDBï¼Œç¡®ä¿ç”¨æˆ·ä¸­å¿ƒèƒ½çœ‹åˆ°æ–°è®°å½•
            try {
                if (typeof LocalDB !== 'undefined') {
                    const localDB = new LocalDB();
                    localDB.addAnalysisRecord(resultData).then(() => {
                        console.log('âœ… åˆ†æè®°å½•å·²ä¿å­˜åˆ°IndexedDB');
                        
                        // è§¦å‘å…¨å±€åŒæ­¥ï¼Œç¡®ä¿æ‰€æœ‰é¡µé¢éƒ½èƒ½çœ‹åˆ°æ›´æ–°
                        if (window.ultimateSyncSystem && typeof window.ultimateSyncSystem.triggerGlobalSync === 'function') {
                            window.ultimateSyncSystem.triggerGlobalSync();
                        }
                    }).catch(err => {
                        console.error('âŒ ä¿å­˜åˆ†æè®°å½•åˆ°IndexedDBå¤±è´¥:', err);
                    });
                } else {
                    console.warn('âš ï¸ LocalDBæœªå®šä¹‰ï¼Œæ— æ³•ç›´æ¥ä¿å­˜åˆ°IndexedDB');
                }
            } catch (error) {
                console.error('âŒ ä¿å­˜åˆ†æè®°å½•åˆ°IndexedDBå¤–å±‚æ•è·å¤±è´¥:', error);
            }
        }
        
        // æ–°å»ºåˆ†ææŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById('new-analysis-btn').addEventListener('click', function() {
            // é‡ç½®æ‰€æœ‰çŠ¶æ€
            analysisResultCard.classList.add('hidden');
            modelSelectionCard.classList.add('hidden');
            selectedFile.classList.add('hidden');
            fileInput.value = '';
            dataTypeRadios.forEach(radio => radio.checked = false);
            modelRadios.forEach(radio => radio.checked = false);
            nextStepBtn.disabled = true;
            startAnalysisBtn.disabled = true;
            svmModel.classList.remove('model-card-active');
            randomForestModel.classList.remove('model-card-active');
            
            // é‡ç½®æ­¥éª¤æŒ‡ç¤ºå™¨
            stepIndicators[0].querySelector('div').classList.remove('bg-gray-200', 'text-gray-500');
            stepIndicators[0].querySelector('div').classList.add('bg-primary', 'text-white');
            stepIndicators[0].querySelector('span').classList.remove('text-gray-500');
            stepIndicators[0].querySelector('span').classList.add('text-primary', 'font-medium');
            stepIndicators[0].nextElementSibling.classList.remove('bg-gray-200');
            stepIndicators[0].nextElementSibling.classList.add('bg-primary');
            stepIndicators[1].querySelector('div').classList.remove('bg-primary', 'text-white');
            stepIndicators[1].querySelector('div').classList.add('bg-gray-200', 'text-gray-500');
            stepIndicators[1].querySelector('span').classList.remove('text-primary', 'font-medium');
            stepIndicators[1].querySelector('span').classList.add('text-gray-500');
            stepIndicators[1].nextElementSibling.classList.remove('bg-primary');
            stepIndicators[1].nextElementSibling.classList.add('bg-gray-200');
            stepIndicators[2].querySelector('div').classList.remove('bg-primary', 'text-white');
            stepIndicators[2].querySelector('div').classList.add('bg-gray-200', 'text-gray-500');
            stepIndicators[2].querySelector('span').classList.remove('text-primary', 'font-medium');
            stepIndicators[2].querySelector('span').classList.add('text-gray-500');
        });
        
        // æŸ¥çœ‹å†å²æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById('view-history-btn').addEventListener('click', function() {
            window.location.href = 'user_center.html';
        });
        
        // åˆå§‹åŒ–ç”Ÿç†æŒ‡æ ‡é›·è¾¾å›¾
        function initPhysiologicalChart() {
            const ctx = document.getElementById('physiologicalChart').getContext('2d');
            
            const physiologicalChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: [
                        'æƒ…ç»ªç¨³å®šæ€§',
                        'å‹åŠ›æ°´å¹³',
                        'è®¤çŸ¥åŠŸèƒ½',
                        'ç¡çœ è´¨é‡',
                        'å¿ƒç‡å˜å¼‚æ€§'
                    ],
                    datasets: [{
                        label: 'ç”¨æˆ·æŒ‡æ ‡',
                        data: [88, 45, 92, 72, 85],
                        fill: true,
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        pointBackgroundColor: 'rgba(59, 130, 246, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(59, 130, 246, 1)'
                    }, {
                        label: 'å¥åº·å‚è€ƒå€¼',
                        data: [80, 50, 80, 75, 80],
                        fill: true,
                        backgroundColor: 'rgba(16, 185, 129, 0.2)',
                        borderColor: 'rgba(16, 185, 129, 1)',
                        pointBackgroundColor: 'rgba(16, 185, 129, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(16, 185, 129, 1)'
                    }]
                },
                options: {
                    scales: {
                        r: {
                            angleLines: {
                                display: true
                            },
                            suggestedMin: 0,
                            suggestedMax: 100
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                        }
                    }
                }
            });
        }
        
        // å¯¼èˆªæ æ»šåŠ¨æ•ˆæœ
        window.addEventListener('scroll', () => {
            const nav = document.querySelector('nav');
            if (window.scrollY > 10) {
                nav.classList.add('py-2');
                nav.classList.remove('py-3');
            } else {
                nav.classList.add('py-3');
                nav.classList.remove('py-2');
            }
        });
        
        // åŠ è½½ç”¨æˆ·èµ„æ–™
        async function loadUserProfile() {
            try {
                // é¦–å…ˆæ£€æŸ¥æ˜¯å¦æœ‰åŒæ­¥æ•°æ®
                const syncData = localStorage.getItem('userProfileData');
                if (syncData) {
                    const profile = JSON.parse(syncData);
                    updateProfileDisplay(profile);
                    console.log('ä»åŒæ­¥æ•°æ®åŠ è½½ç”¨æˆ·èµ„æ–™');
                    return;
                }
                
                // åŸæœ‰æ•°æ®åº“åŠ è½½é€»è¾‘
                if (typeof LocalDB === 'undefined') {
                    console.warn('LocalDBç±»æœªå®šä¹‰ï¼Œæ— æ³•åŠ è½½ç”¨æˆ·èµ„æ–™');
                    return;
                }
                
                const localDB = new LocalDB();
                const profile = await localDB.getUserProfile();
                
                if (profile) {
                    updateProfileDisplay(profile);
                    
                    // ä¿å­˜åˆ°åŒæ­¥å­˜å‚¨
                    localStorage.setItem('userProfileData', JSON.stringify(profile));
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·èµ„æ–™å¤±è´¥:', error);
            }
        }
        
        // æ›´æ–°èµ„æ–™æ˜¾ç¤º
        function updateProfileDisplay(profile) {
            // è®¾ç½®é»˜è®¤å€¼
            const defaultName = profile.name || profile.fullname || 'ç”¨æˆ·';
            const defaultAvatar = profile.avatar || 'https://picsum.photos/id/91/40/40';
            
            // æ›´æ–°æ¡Œé¢ç«¯å¯¼èˆªæ 
            const desktopUserDiv = document.querySelector('.hidden.md\:flex.items-center.space-x-6 > div.flex.items-center.space-x-2');
            if (desktopUserDiv) {
                const desktopAvatar = desktopUserDiv.querySelector('img');
                const desktopName = desktopUserDiv.querySelector('span');
                if (desktopAvatar) {
                    desktopAvatar.src = defaultAvatar;
                    desktopAvatar.alt = defaultName;
                }
                if (desktopName) {
                    desktopName.textContent = defaultName;
                }
                console.log('å·²æ›´æ–°æ¡Œé¢ç«¯ç”¨æˆ·ä¿¡æ¯');
            }
            
            // æ›´æ–°ç§»åŠ¨ç«¯å¯¼èˆªæ 
            const mobileMenu = document.getElementById('mobile-menu');
            if (mobileMenu) {
                const mobileUserDiv = mobileMenu.querySelector('div.flex.items-center.space-x-2');
                if (mobileUserDiv) {
                    const mobileAvatar = mobileUserDiv.querySelector('img');
                    const mobileName = mobileUserDiv.querySelector('span');
                    if (mobileAvatar) {
                        mobileAvatar.src = defaultAvatar;
                        mobileAvatar.alt = defaultName;
                    }
                    if (mobileName) {
                        mobileName.textContent = defaultName;
                    }
                    console.log('å·²æ›´æ–°ç§»åŠ¨ç«¯ç”¨æˆ·ä¿¡æ¯');
                }
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        // è®¾ç½®ç”¨æˆ·èµ„æ–™åŒæ­¥ç›‘å¬å™¨ï¼ˆä¿ç•™ä»¥ç¡®ä¿å…¼å®¹æ€§ï¼‰
        function setupProfileSyncListener() {
            console.log('è®¾ç½®ç”¨æˆ·èµ„æ–™åŒæ­¥ç›‘å¬å™¨ï¼ˆå…¼å®¹æ¨¡å¼ï¼‰');
            
            // å¦‚æœç»ˆæåŒæ­¥ç³»ç»Ÿå·²åŠ è½½ï¼Œä¼˜å…ˆä½¿ç”¨å®ƒ
            if (window.ultimateSyncSystem) {
                console.log('âœ… æ£€æµ‹åˆ°ç»ˆæåŒæ­¥ç³»ç»Ÿå·²åŠ è½½ï¼Œä½¿ç”¨å…¶åŒæ­¥åŠŸèƒ½');
                
                // ç›‘å¬è‡ªå®šä¹‰äº‹ä»¶
                window.addEventListener('ultimateProfileUpdated', (e) => {
                    console.log('ğŸ”„ æ¥æ”¶åˆ°ç»ˆæåŒæ­¥ç³»ç»Ÿçš„èµ„æ–™æ›´æ–°äº‹ä»¶');
                    // å¦‚æœ‰éœ€è¦å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ é¢å¤–å¤„ç†
                });
            } else {
                // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨åŸæœ‰åŒæ­¥é€»è¾‘
                console.log('âš ï¸ ç»ˆæåŒæ­¥ç³»ç»ŸæœªåŠ è½½ï¼Œä½¿ç”¨å¤‡ç”¨åŒæ­¥é€»è¾‘');
                
                // ç›‘å¬localStorageå˜åŒ–
                window.addEventListener('storage', (e) => {
                    if (e.key === 'userProfileData' || e.key === 'userProfileUpdated' || e.key === 'userProfileLastUpdate') {
                        console.log('æ£€æµ‹åˆ°ç”¨æˆ·èµ„æ–™å˜åŒ–ï¼Œé‡æ–°åŠ è½½...');
                        loadUserProfile();
                    }
                });
                
                // è®¾ç½®å®šæœŸæ£€æŸ¥ï¼ˆæ¯30ç§’ï¼‰
                setInterval(() => {
                    const lastUpdate = localStorage.getItem('userProfileLastUpdate');
                    if (lastUpdate) {
                        console.log('å®šæœŸæ£€æŸ¥ç”¨æˆ·èµ„æ–™æ›´æ–°');
                    }
                }, 30000);
            }
        }

        // ä»localStorageè·å–ç™»å½•ç”¨æˆ·ä¿¡æ¯
        function getLoggedInUser() {
            try {
                // ä¼˜å…ˆä½¿ç”¨userCredentialsé”®ï¼Œä¿æŒä¸å…¶ä»–é¡µé¢ä¸€è‡´æ€§
                const credentials = localStorage.getItem('userCredentials');
                if (credentials) {
                    return JSON.parse(credentials);
                }
                // å…¼å®¹æ—§ç‰ˆé€»è¾‘
                if (localStorage.getItem('userLoggedIn') === 'true') {
                    const currentUser = localStorage.getItem('currentUser');
                    return currentUser ? JSON.parse(currentUser) : null;
                }
                return null;
            } catch (error) {
                console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
                return null;
            }
        }
        
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
        function checkLoginStatus() {
            try {
                const user = getLoggedInUser();
                
                // å¦‚æœæ²¡æœ‰ç™»å½•å‡­è¯ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µé¢
                if (!user || !user.username) {
                    console.warn('æœªæ£€æµ‹åˆ°ç™»å½•çŠ¶æ€ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µé¢...');
                    window.location.href = 'login.html';
                    return false;
                }
                
                console.log('å·²æ£€æµ‹åˆ°ç™»å½•çŠ¶æ€ï¼Œå½“å‰ç”¨æˆ·:', user.username);
                return true;
            } catch (error) {
                console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€æ—¶å‘ç”Ÿé”™è¯¯:', error);
                window.location.href = 'login.html';
                return false;
            }
        }
        
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ğŸŒ åˆ†æä¸­å¿ƒé¡µé¢åˆå§‹åŒ–');
            
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            if (!checkLoginStatus()) {
                // å¦‚æœæœªç™»å½•ï¼Œä¸æ‰§è¡Œåç»­ä»£ç 
                return;
            }
            
            // ç»ˆæåŒæ­¥ç³»ç»Ÿä¼šè‡ªåŠ¨å¤„ç†ç”¨æˆ·èµ„æ–™åŒæ­¥
            // å¦‚æœéœ€è¦æ‰‹åŠ¨åˆå§‹åŠ è½½ä¸€æ¬¡
            if (window.ultimateSyncSystem && typeof window.ultimateSyncSystem.syncUserProfile === 'function') {
                await window.ultimateSyncSystem.syncUserProfile();
            } else {
                // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨åŸæœ‰åŠ è½½é€»è¾‘
                await loadUserProfile();
                
                // ä¿ç•™åŸæœ‰ç›‘å¬ï¼Œç¡®ä¿å…¼å®¹æ€§
                if (typeof LocalDB !== 'undefined') {
                    try {
                        const localDB = new LocalDB();
                        localDB.subscribe('profileUpdated', () => {
                            console.log('ç”¨æˆ·èµ„æ–™å·²æ›´æ–°ï¼Œé‡æ–°åŠ è½½...');
                            loadUserProfile();
                        });
                    } catch (error) {
                        console.error('è®¢é˜…ç”¨æˆ·èµ„æ–™æ›´æ–°å¤±è´¥:', error);
                    }
                }
            }
        });
    </script>
</body>
</html>